# Heatmap top 2000 HVGs --------------------------------------------------------
logcounts_mat <- as.matrix(GetAssayData(seurat_obj, slot = "data"))

gene_vars <- apply(logcounts_mat, 1, var)

top_var_genes <- names(sort(gene_vars, decreasing = TRUE))[1:2000]

logcounts_var <- logcounts_mat[top_var_genes, ]

logcounts_var_scaled <- t(scale(t(logcounts_var)))
colnames(logcounts_var_scaled) <- colnames(logcounts_var)
fiber_type_data <- readRDS("objects/fiber_type_data_roger.rds")
rownames(fiber_type_data) <- fiber_type_data$fiber_ID

# Add fiber type to existing annotation
annotation_col$fiber_type <- fiber_type_data[rownames(annotation_col), "fiber_type"]

annotation_col$fiber_type <- fiber_type_data[rownames(annotation_col), "fiber_type"][[1]]

annotation_col$fiber_type <- factor(annotation_col$fiber_type)

annotation_col$cluster_status <- ifelse(
  rownames(annotation_col) %in% cluster_fibers,
  "Cluster",
  "Other"
)

ann_colors <- list(
  cluster_status = c(Cluster = "#1f78b4", Other = "#b2df8a"),
  condition = c(Control = "#e31a1c", `ICU-AW` = "#33a02c"),
  fiber_type = c('Hybrid 1/2A' = "blue", 'Hybrid 2A/2X' = "purple", 'Type 1' = "green", 'Type 2A' = "pink")
)

heat_all <- pheatmap(
  logcounts_var_scaled,           
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  annotation_col = annotation_col,
  annotation_colors = ann_colors,
  show_rownames = FALSE,
  show_colnames = FALSE,
  scale = "row",
  main = "Per-fiber expression of top 2000 variable genes",
  silent = TRUE
)

grid::grid.newpage()
heat_all

# Heatmap all ------------------------------------------------------------------
# Doesn't work, requires too much computation

expr_mat <- logcounts_mat

expr_scaled <- t(scale(t(expr_mat)))
colnames(expr_scaled) <- colnames(expr_mat)

annotation_col$cluster_status <- ifelse(
  rownames(annotation_col) %in% cluster_fibers,
  "Cluster",
  "Other"
)

cluster_order <- order(annotation_col$cluster_status)
expr_scaled_ordered <- expr_scaled[, cluster_order]
annotation_col_ordered <- annotation_col[cluster_order, ]

ann_colors <- list(
  cluster_status = c(Cluster = "#1f78b4", Other = "#b2df8a"),
  condition = c(Control = "#e31a1c", `ICU-AW` = "#33a02c")
)

heat_compressed <- pheatmap(
  expr_scaled_ordered,
  cluster_rows = FALSE,
  cluster_cols = FALSE,
  show_rownames = FALSE,
  show_colnames = FALSE,
  annotation_colors = ann_colors,
  main = "Expression heatmap of all genes (compressed)",
  silent = TRUE
)

grid::grid.newpage()
heat_compressed

# Non-pseudobulk condition DE with duplicateCorrelation ------------------------

counts_mat <- as.matrix(GetAssayData(seurat_obj, slot = "counts"))

meta <- seurat_obj@meta.data

all(colnames(counts_mat) == meta$fiber_id)
dge <- DGEList(counts = counts_mat)

keep <- filterByExpr(dge, group = meta$group)
dge <- dge[keep, ]

dge <- calcNormFactors(dge)

meta$group <- factor(meta$group, levels = c("C", "S"))
design <- model.matrix(~ group, data = meta)
v <- voom(dge, design, plot = TRUE)

corfit <- duplicateCorrelation(
  v,
  design,
  block = meta$sample   # donor ID
)

v <- voom(
  dge,
  design,
  block = meta$sample,
  correlation = corfit$consensus.correlation,
  plot = TRUE
)

fit <- lmFit(
  v,
  design,
  block = meta$sample,
  correlation = corfit$consensus.correlation
)

fit <- eBayes(fit)
res_voom_fiber <- topTable(
  fit,
  coef = "groupS",
  number = Inf,
  sort.by = "P"
)

res_voom_fiber$FDR <- p.adjust(res_voom_fiber$P.Value, method = "bonferroni")
volcano_df <- res_voom_fiber %>%
  mutate(
    gene = rownames(res_voom_fiber),
    negLogP = -log10(P.Value),
    Signif_FDR = ifelse(FDR < 0.05 & abs(logFC) > 1, "sig", "ns")
  )
p_fdr_cutoff <- max(
  volcano_df$P.Value[volcano_df$FDR < 0.01],
  na.rm = TRUE
)
ggplot(volcano_df, aes(x = logFC, y = negLogP)) +
  geom_point(aes(color = Signif_FDR), alpha = 0.7, size = 2) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed") +
  geom_hline(yintercept = -log10(p_fdr_cutoff), linetype = "dashed") +
  scale_color_manual(values = c(sig = "red", ns = "grey")) +
  geom_text_repel(
    data = subset(volcano_df, Signif_FDR == "sig"),
    aes(label = gene),
    size = 3,
    max.overlaps = 20
  ) +
  labs(
    title = "Volcano — per-fiber limma–voom (ICU-AW vs Control)",
    x = "log2 Fold Change (ICU-AW / Control)",
    y = "-log10(p-value)"
  ) +
  theme_minimal()

# Heatmap of DEGs

sig_genes <- rownames(res_voom_fiber)[res_voom_fiber$FDR < 0.05]
expr_sig <- expr_mat[sig_genes, ]

expr_sig_scaled <- t(scale(t(expr_sig)))

heat_sig <- pheatmap(
  expr_sig_scaled[, cluster_order], #option to reorder
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  annotation_col = annotation_col_ordered,
  show_rownames = TRUE,
  show_colnames = FALSE,
  annotation_colors = ann_colors,
  main = "Expression of significant genes (fiber-level)",
  silent = TRUE
)
grid::grid.newpage()
heat_sig

# Non-pseudobulk heatmap of top 200 DEGs ---------------------------------------
res_voom_fiber$FDR <- p.adjust(res_voom_fiber$P.Value, method = "bonferroni")

top_n <- 50
top_genes <- rownames(res_voom_fiber[order(res_voom_fiber$FDR), ])[1:top_n]

expr_top <- expr_mat[top_genes, ]

expr_top_scaled <- t(scale(t(expr_top)))
annotation_col_ordered <- annotation_col[colnames(expr_top_scaled), ]
heat_top <- pheatmap(
  expr_top_scaled,
  cluster_rows = TRUE,      
  cluster_cols = TRUE,     
  annotation_col = annotation_col_ordered,  
  annotation_colors = ann_colors,
  show_rownames = TRUE,
  show_colnames = FALSE,
  scale = "row",
  main = "Top 50 DEGs (per-fiber limma–voom)",
  silent = TRUE
)

grid::grid.newpage()
heat_top

#Group by cluster status
annotation_col$cluster_status <- factor(annotation_col$cluster_status, levels = c("Cluster", "Other"))
cluster_order <- order(annotation_col$cluster_status)
expr_top_ordered <- expr_top_scaled[, cluster_order]
annotation_col_ordered <- annotation_col[cluster_order, ]
heat_top <- pheatmap(
  expr_top_ordered,
  cluster_rows = TRUE,         
  cluster_cols = FALSE,     
  annotation_col = annotation_col_ordered,  
  annotation_colors = ann_colors,
  show_rownames = TRUE,
  show_colnames = FALSE,
  scale = "row",
  main = "Top 50 DEGs grouped by cluster status",
  silent = TRUE
)
grid::grid.newpage()
heat_top

# Non-pseudobulk condition DE withOUT duplicateCorrelation ---------------------

counts_mat <- as.matrix(GetAssayData(seurat_obj, slot = "counts"))
meta <- seurat_obj@meta.data

stopifnot(all(colnames(counts_mat) == meta$fiber_id))

dge <- DGEList(counts = counts_mat)

keep <- filterByExpr(dge, group = meta$group)
dge <- dge[keep, ]

dge <- calcNormFactors(dge)

meta$group <- factor(meta$group, levels = c("C", "S"))
design <- model.matrix(~ group, data = meta)
colnames(design)

v <- voom(dge, design, plot = TRUE)

fit <- lmFit(v, design)
fit <- eBayes(fit)

res_voom_fiber <- topTable(
  fit,
  coef = "groupS",
  number = Inf,
  sort.by = "P"
)

res_voom_fiber$FDR <- p.adjust(res_voom_fiber$P.Value, method = "bonferroni")

volcano_df <- res_voom_fiber |>
  transform(
    gene = rownames(res_voom_fiber),
    negLogP = -log10(P.Value),
    Signif = FDR < 0.05 & abs(logFC) > 1
  )

p_fdr_cutoff <- max(
  volcano_df$P.Value[volcano_df$FDR < 0.05],
  na.rm = TRUE
)

ggplot(volcano_df, aes(x = logFC, y = negLogP)) +
  geom_point(aes(color = Signif), alpha = 0.7, size = 2) +
  scale_color_manual(values = c("TRUE" = "red", "FALSE" = "grey70")) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed") +
  geom_hline(yintercept = -log10(p_fdr_cutoff), linetype = "dashed") +
  geom_text_repel(
    data = subset(volcano_df, Signif),
    aes(label = gene),
    size = 3,
    max.overlaps = 20
  ) +
  labs(
    title = "Per-fiber DE (limma–voom, no donor blocking)",
    x = "log2 Fold Change (ICU-AW / Control)",
    y = "-log10(p-value)"
  ) +
  theme_minimal()
#Heatmap with sig genes --------------------------------------------------------
sig_genes <- rownames(res_voom_fiber)[res_voom_fiber$FDR < 0.05]
expr_sig <- counts_mat[sig_genes, ]

dge <- DGEList(counts = expr_sig)
dge <- calcNormFactors(dge)
logcpm <- edgeR::cpm(dge, log = TRUE, prior.count = 1)

logcpm_scaled <- t(scale(t(logcpm)))

annotation_col <- data.frame(
  group = meta$group,               # ICU-AW vs Control
  cluster = meta$in_cluster         # Cluster membership
)
rownames(annotation_col) <- meta$fiber_id

ann_colors <- list(
  group = c(C = "skyblue", S = "salmon"),
  cluster = c(other = "grey70", cluster = "gold")
)

heat_sig <- pheatmap(
  logcpm_scaled,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  annotation_col = annotation_col,
  annotation_colors = ann_colors,
  show_rownames = TRUE,
  show_colnames = FALSE,
  main = "Expression of significant genes (per-fiber)",
  silent = TRUE
)

grid::grid.newpage()
heat_sig
# Non-pseudobulk cluster DE ----------------------------------------------------
counts_mat <- as.matrix(GetAssayData(seurat_obj, slot = "counts"))
meta <- seurat_obj@meta.data

stopifnot(all(colnames(counts_mat) == meta$fiber_id))
meta$in_cluster <- ifelse(
  meta$fiber_id %in% cluster_fibers,
  "Cluster",
  "Other"
)

meta$in_cluster <- factor(meta$in_cluster, levels = c("Other", "Cluster"))
table(meta$in_cluster)
dge <- DGEList(counts = counts_mat)

keep <- filterByExpr(dge, group = meta$in_cluster)
dge <- dge[keep, ]

dge <- calcNormFactors(dge)
design <- model.matrix(~ in_cluster, data = meta)
colnames(design)
v <- voom(dge, design, plot = TRUE)

fit <- lmFit(v, design)
fit <- eBayes(fit)
res_cluster <- topTable(
  fit,
  coef = "in_clusterCluster",
  number = Inf,
  sort.by = "P"
)
res_cluster$FDR_bonf <- p.adjust(res_cluster$P.Value, method = "bonferroni")
sig_genes <- rownames(res_cluster)[
  res_cluster$FDR_bonf < 0.05 & abs(res_cluster$logFC) > 1
]

length(sig_genes)
sig_genes

volcano_df <- res_cluster |>
  transform(
    gene = rownames(res_cluster),
    negLogP = -log10(P.Value),
    sig = FDR_bonf < 0.05 & abs(logFC) > 1
  )

ggplot(volcano_df, aes(logFC, negLogP)) +
  geom_point(aes(color = sig), alpha = 0.7, size = 2) +
  scale_color_manual(values = c("FALSE" = "grey70", "TRUE" = "red")) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed") +
  geom_text_repel(
    data = subset(volcano_df, sig),
    aes(label = gene),
    size = 3,
    max.overlaps = 20,
    box.padding = 0.3,
    point.padding = 0.2
  ) +
  labs(
    title = "Per-fiber DE: Cluster vs Other",
    x = "log2 fold change (Cluster / Other)",
    y = "-log10(p-value)"
  ) +
  theme_minimal()

# Protein non-bulked no duplicateCorrelation -----------------------------------
counts_mat <- as.matrix(GetAssayData(seurat_object, slot = "counts"))
meta <- seurat_object@meta.data

stopifnot(all(colnames(counts_mat) == meta$fiber_id))

meta$condition <- factor(meta$condition, levels = c("c", "s"))

dge <- DGEList(counts = counts_mat)

keep <- filterByExpr(dge, group = meta$condition)
dge <- dge[keep, ]

dge <- calcNormFactors(dge)

design <- model.matrix(~ 0 + condition, data = meta)
colnames(design) <- levels(meta$condition)

v <- voom(dge, design, plot = TRUE)
fit <- lmFit(v, design)
fit <- eBayes(fit)

DE_results <- topTable(
  fit,
  coef = "s",
  number = Inf,
  sort.by = "P"
)

DE_results$FDR <- p.adjust(DE_results$P.Value, method = "bonferroni")

volcano_df <- DE_results |>
  transform(
    gene = rownames(DE_results),
    negLogP = -log10(P.Value),
    Signif_FDR = FDR < 0.05 & abs(logFC) > 1
  )
p_fdr_cutoff <- max(
  volcano_df$P.Value[volcano_df$FDR < 0.05],
  na.rm = TRUE
)


ggplot(volcano_df, aes(x = logFC, y = negLogP, color = Signif_FDR)) +
  geom_point(size = 1.5, alpha = 0.7) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed") +
  geom_hline(yintercept = -log10(p_fdr_cutoff), linetype = "dashed") +
  scale_color_manual(values = c("grey70", "red")) +
  geom_text_repel(
    data = subset(volcano_df, Signif_FDR),
    aes(label = gene),
    size = 3,
    max.overlaps = 20
  ) +
  labs(
    title = "Volcano Protein — ICU-AW vs Control (per-fiber limma–voom)",
    x = "log2 Fold Change (ICU-AW / Control)",
    y = "-log10(p-value)"
  ) +
  theme_minimal()
# RNA cluster DE with donor-blocking -------------------------------------------
counts_mat <- as.matrix(GetAssayData(seurat_obj, slot = "counts"))
meta <- seurat_obj@meta.data
stopifnot(all(colnames(counts_mat) == meta$fiber_id))

# Define cluster status
meta$in_cluster <- ifelse(meta$fiber_id %in% cluster_fibers, "Cluster", "Other")
meta$in_cluster <- factor(meta$in_cluster, levels = c("Other", "Cluster"))
table(meta$in_cluster)

# DGEList
dge <- DGEList(counts = counts_mat)
keep <- filterByExpr(dge, group = meta$in_cluster)
dge <- dge[keep, , keep.lib.sizes = FALSE]
dge <- calcNormFactors(dge, method = "TMM")

# Fixed-effect donor design
design <- model.matrix(~ in_cluster + sample, data = meta)  # sample = donor
colnames(design)  # just to check

# Voom transformation
v <- voom(dge, design = design, plot = TRUE)

# Fit linear model (no duplicateCorrelation)
fit <- lmFit(v, design)
fit <- eBayes(fit)

# Extract DE results for cluster effect
res_cluster <- topTable(fit, coef = "in_clusterCluster", number = Inf, sort.by = "P")
res_cluster$FDR_bonf <- p.adjust(res_cluster$P.Value, method = "bonferroni")

# Significant genes
sig_genes <- rownames(res_cluster)[res_cluster$FDR_bonf < 0.05 & abs(res_cluster$logFC) > 1]
length(sig_genes)
sig_genes

# Volcano plot
volcano_df <- res_cluster %>%
  rownames_to_column("gene") %>%
  mutate(
    negLogP = -log10(P.Value),
    sig = FDR_bonf < 0.05 & abs(logFC) > 1
  )

ggplot(volcano_df, aes(x = logFC, y = negLogP)) +
  geom_point(aes(color = sig), alpha = 0.7, size = 2) +
  scale_color_manual(values = c("FALSE" = "grey70", "TRUE" = "red")) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed") +
  geom_text_repel(
    data = subset(volcano_df, sig),
    aes(label = gene),
    size = 3,
    max.overlaps = 20,
    box.padding = 0.3,
    point.padding = 0.2
  ) +
  labs(
    title = "Per-fiber DE: Cluster vs Other (fixed-effect donor)",
    x = "log2 fold change (Cluster / Other)",
    y = "-log10(p-value)"
  ) +
  theme_minimal()

# Non-pseudobulk cluster DE protein --------------------------------------------
stopifnot(all(colnames(mat) == filtered_metadata$fiber_id))

filtered_metadata$in_cluster <- ifelse(
  filtered_metadata$fiber_id %in% cluster_fibers,
  "Cluster",
  "Other"
)
filtered_metadata$in_cluster <- factor(filtered_metadata$in_cluster, levels = c("Other", "Cluster"))
table(filtered_metadata$in_cluster)

mat[is.na(mat)] <- 0
dge <- DGEList(counts = mat)

keep <- filterByExpr(dge, group = filtered_metadata$in_cluster)
dge <- dge[keep, , keep.lib.sizes = FALSE]

dge <- calcNormFactors(dge, method = "TMM")

design <- model.matrix(~ in_cluster, data = filtered_metadata)
colnames(design)

v <- voom(dge, design = design, plot = TRUE)

corfit <- duplicateCorrelation(v, design = design, block = filtered_metadata$subject)

v_block <- voom(dge, design = design,
                block = filtered_metadata$subject,
                correlation = corfit$consensus.correlation,
                plot = TRUE)

fit <- lmFit(v_block, design,
             block = filtered_metadata$subject,
             correlation = corfit$consensus.correlation)
fit <- eBayes(fit)

res_cluster <- topTable(
  fit,
  coef = "in_clusterCluster",
  number = Inf,
  sort.by = "P"
)
res_cluster$FDR_bonf <- p.adjust(res_cluster$P.Value, method = "bonferroni")

sig_proteins <- rownames(res_cluster)[res_cluster$FDR_bonf < 0.05 & abs(res_cluster$logFC) > 1]
length(sig_proteins)
sig_proteins

volcano_df <- res_cluster %>%
  rownames_to_column("protein") %>%
  mutate(
    negLogP = -log10(P.Value),
    sig = FDR_bonf < 0.05 & abs(logFC) > 1
  )

ggplot(volcano_df, aes(x = logFC, y = negLogP)) +
  geom_point(aes(color = sig), alpha = 0.7, size = 2) +
  scale_color_manual(values = c("FALSE" = "grey70", "TRUE" = "red")) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed") +
  geom_text_repel(
    data = subset(volcano_df, sig),
    aes(label = protein),
    size = 3,
    max.overlaps = 20,
    box.padding = 0.3,
    point.padding = 0.2
  ) +
  labs(
    title = "Per-fiber DE: Cluster vs Other (Protein, donor-blocked)",
    x = "log2 fold change (Cluster / Other)",
    y = "-log10(p-value)"
  ) +
  theme_minimal()


























stopifnot(all(colnames(counts_mat) == meta$fiber_id))

meta$condition <- factor(meta$group, levels = c("C", "S")) 
meta$donor <- factor(meta$sample) 


design_matrix <- model.matrix(~ 0 + condition + donor, data = meta)

colnames(design_matrix)

colnames(design_matrix)[1:length(levels(meta$condition))] <- levels(meta$condition)

dge <- DGEList(counts = counts_mat)
dge <- calcNormFactors(dge)

v <- voom(dge, design_matrix, plot = TRUE)
fit <- lmFit(v, design_matrix)
fit <- eBayes(fit)

contrast_matrix <- makeContrasts(S_vs_C = S - C, levels = design_matrix)
fit2 <- contrasts.fit(fit, contrast_matrix)
fit2 <- eBayes(fit2)

DE_results <- topTable(fit2, number = Inf, sort.by = "P")

DE_results <- DE_results %>%
  mutate(
    gene = rownames(DE_results),
    FDR = p.adjust(P.Value, method = "bonferroni"),
    negLogP = -log10(P.Value),
    Signif = FDR < 0.05 & abs(logFC) > 1
  )
p_fdr_cutoff <- max(DE_results$P.Value[DE_results$FDR < 0.05], na.rm = TRUE)

ggplot(DE_results, aes(x = logFC, y = negLogP, color = Signif)) +
  geom_point(alpha = 0.7, size = 2) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed") +
  geom_hline(yintercept = -log10(p_fdr_cutoff), linetype = "dashed") +
  scale_color_manual(values = c("FALSE" = "grey70", "TRUE" = "red")) +
  geom_text_repel(
    data = subset(DE_results, Signif),
    aes(label = gene),
    size = 3,
    max.overlaps = 20
  ) +
  labs(
    title = "Volcano — per-fiber limma–voom (S vs C)",
    x = "log2 Fold Change (S / C)",
    y = "-log10(p-value)"
  ) +
  theme_minimal()
